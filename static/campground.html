<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Schniffground</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <!-- Lightpick CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightpick@1.6.2/css/lightpick.css">
    <style>
        body {
            font-family: monospace;
            background: #0d0d0f;
            color: #e0e0e0;
            margin: 0;
            padding: 1rem;
        }

        #title {
            font-size: 1.2rem;
            margin-bottom: .25rem;
            font-weight: 600;
        }

        #meta {
            color: #8a8a92;
            margin-bottom: 1rem;
        }

        #ascii {
            white-space: pre;
            overflow-x: auto;
            background: #16161a;
            padding: 1rem;
            border: 1px solid #303036;
            border-radius: 6px;
            line-height: 1.1;
            font-family: "Courier New", Courier, monospace, "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji";
            font-size: 14px;
        }

        #controls {
            margin-bottom: .5rem;
            display: flex;
            gap: .5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        select,
        input {
            background: #202024;
            color: #fff;
            border: 1px solid #303036;
            border-radius: 4px;
            padding: .35rem .6rem;
        }

        /* Date range picker styling */
        #daterange {
            background: #202024;
            color: #fff;
            border: 1px solid #303036;
            border-radius: 4px;
            padding: .35rem .6rem;
            cursor: pointer;
            min-width: 200px;
        }

        button {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            padding: .35rem .8rem;
            cursor: pointer;
        }

        button:hover {
            background: #2563eb;
        }

        button:disabled {
            background: #6b7280;
            cursor: not-allowed;
        }

        small {
            color: #8a8a92;
            margin-top: .5rem;
            display: block;
        }

        /* Lightpick dark mode styling */
        .lightpick {
            background: #16161a !important;
            border: 1px solid #303036 !important;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5) !important;
        }

        .lightpick__month {
            background: #16161a !important;
            color: #e0e0e0 !important;
        }

        .lightpick__month-title {
            color: #e0e0e0 !important;
            background: #202024 !important;
            border-bottom: 1px solid #303036 !important;
        }

        .lightpick__days-of-the-week>div {
            color: #8a8a92 !important;
            background: #202024 !important;
            border-bottom: 1px solid #303036 !important;
        }

        .lightpick__day {
            color: #e0e0e0 !important;
        }

        .lightpick__day:hover {
            background: #303036 !important;
            color: #fff !important;
        }

        .lightpick__day--available:hover {
            background: #303036 !important;
            color: #fff !important;
        }

        .lightpick__day--disabled {
            color: #6b7280 !important;
        }

        .lightpick__day--in-range {
            background: #2d4a63 !important;
            color: #e0e0e0 !important;
        }

        .lightpick__day--start-date,
        .lightpick__day--end-date {
            background: #3b82f6 !important;
            color: #fff !important;
        }

        .lightpick__day--start-date:hover,
        .lightpick__day--end-date:hover {
            background: #2563eb !important;
            color: #fff !important;
        }

        .lightpick__previous-action,
        .lightpick__next-action {
            color: #e0e0e0 !important;
        }

        .lightpick__previous-action:hover,
        .lightpick__next-action:hover {
            color: #3b82f6 !important;
        }

        .lightpick__tooltip {
            background: #202024 !important;
            color: #e0e0e0 !important;
            border: 1px solid #303036 !important;
        }

        .lightpick__tooltip:before {
            border-top-color: #303036 !important;
        }

        .lightpick__tooltip:after {
            border-top-color: #202024 !important;
        }

        /* Year/Month dropdown styling */
        .lightpick__select {
            background: #202024 !important;
            color: #e0e0e0 !important;
            border: none !important;
            border-radius: 4px !important;
            outline: none !important;
            box-shadow: none !important;
        }

        .lightpick__select:hover {
            background: #303036 !important;
            color: #fff !important;
            border: none !important;
            outline: none !important;
        }

        .lightpick__select:focus {
            background: #303036 !important;
            color: #fff !important;
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
        }

        .lightpick__select option {
            background: #202024 !important;
            color: #e0e0e0 !important;
        }

        /* Navigation buttons (previous/next month) */
        .lightpick__previous-action,
        .lightpick__next-action {
            background: #202024 !important;
            color: #e0e0e0 !important;
            border: 1px solid #303036 !important;
            border-radius: 4px !important;
        }

        .lightpick__previous-action:hover,
        .lightpick__next-action:hover {
            background: #303036 !important;
            color: #3b82f6 !important;
        }

        /* Apply/Reset buttons if they exist */
        .lightpick__apply,
        .lightpick__reset {
            background: #3b82f6 !important;
            color: #fff !important;
            border: 1px solid #3b82f6 !important;
            border-radius: 4px !important;
        }

        .lightpick__apply:hover,
        .lightpick__reset:hover {
            background: #2563eb !important;
            border-color: #2563eb !important;
        }
    </style>
</head>

<body>
    <div id="title">Loading...</div>
    <div id="meta">Loading campground availability...</div>

    <div id="controls">
        <button id="back">‚Üê Map</button>
        <input type="text" id="daterange" name="daterange" />
        <button id="refresh">Refresh</button>
    </div>

    <div id="ascii">Fetching...</div>
    <small>üêΩ üíñ</small>

    <!-- Lightpick dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lightpick@1.6.2/lightpick.js"></script>

    <script>
        document.addEventListener( 'DOMContentLoaded', function () {
            const parts = window.location.pathname.replace( /^\/+/, '' ).split( '/' )
            if ( parts.length < 3 ) {
                document.getElementById( 'ascii' ).textContent = 'Bad path. Expected /campground/{provider}/{id}'
                return
            }
            const provider = parts[ 1 ]
            const campgroundID = parts[ 2 ]
            const titleEl = document.getElementById( 'title' )
            const metaEl = document.getElementById( 'meta' )
            const asciiEl = document.getElementById( 'ascii' )
            const refreshBtn = document.getElementById( 'refresh' )
            const backBtn = document.getElementById( 'back' )

            // Parse URL params or set defaults (today + 3 weeks)
            const urlParams = new URLSearchParams( window.location.search )
            const userParam = urlParams.get( 'user' ) // Get user parameter for ad-hoc requests
            const today = moment()
            const threeWeeksLater = moment().add( 21, 'days' )

            const fromDate = urlParams.get( 'from' ) ? moment( urlParams.get( 'from' ) ) : today
            const toDate = urlParams.get( 'to' ) ? moment( urlParams.get( 'to' ) ) : threeWeeksLater

            // Back button functionality
            backBtn.onclick = function () {
                let mapUrl = '/'
                if ( userParam ) {
                    mapUrl += '?user=' + encodeURIComponent( userParam )
                }
                window.location.href = mapUrl
            }

            // Initialize Lightpick
            const picker = new Lightpick( {
                field: document.getElementById( 'daterange' ),
                singleDate: false,
                startDate: fromDate.toDate(),
                endDate: toDate.toDate(),
                format: 'YYYY-MM-DD',
                separator: ' to ',
                numberOfMonths: 2,
                numberOfColumns: 2,
                onSelect: function ( start, end ) {
                    if ( start && end ) {
                        load()
                    }
                }
            } )

            function updateUrl () {
                const newUrl = new URL( window.location )
                if ( picker.getStartDate() && picker.getEndDate() ) {
                    newUrl.searchParams.set( 'from', moment( picker.getStartDate() ).format( 'YYYY-MM-DD' ) )
                    newUrl.searchParams.set( 'to', moment( picker.getEndDate() ).format( 'YYYY-MM-DD' ) )
                    history.replaceState( null, '', newUrl )
                }
            }

            let loading = false
            async function load () {
                if ( loading ) return // prevent overlap
                loading = true
                refreshBtn.disabled = true
                asciiEl.textContent = 'Loading...'
                try {
                    const from = picker.getStartDate() ? moment( picker.getStartDate() ).format( 'YYYY-MM-DD' ) : fromDate.format( 'YYYY-MM-DD' )
                    const to = picker.getEndDate() ? moment( picker.getEndDate() ).format( 'YYYY-MM-DD' ) : toDate.format( 'YYYY-MM-DD' )
                    const resp = await fetch( `/api/campground_state/${ provider }/${ campgroundID }?from=${ from }&to=${ to }` )
                    const txt = await resp.text()
                    const name = resp.headers.get( 'X-Campground-Name' ) || campgroundID
                    const isRefreshing = resp.headers.get( 'X-Refresh-In-Progress' ) === 'true'

                    titleEl.textContent = `${ name } [${ provider }/${ campgroundID }]`
                    if ( isRefreshing ) {
                        metaEl.textContent = `Refreshing data from ${ from } to ${ to }... will update shortly`
                    } else {
                        metaEl.textContent = `O = available . = unavailable`
                    }
                    asciiEl.textContent = txt
                    updateUrl()

                    // If refresh is in progress, schedule another load in 1 second
                    if ( isRefreshing ) {
                        setTimeout( () => {
                            if ( !loading ) { // Only retry if not already loading
                                load()
                            }
                        }, 1000 )
                    }
                } catch ( e ) {
                    asciiEl.textContent = 'Error: ' + e
                } finally {
                    refreshBtn.disabled = false
                    loading = false
                }
            }

            refreshBtn.onclick = load
            load()
        } );
    </script>
</body>

</html>