<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Schniffground</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <!-- Google Fonts for 8-bit styling -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Press+Start+2P&display=swap" rel="stylesheet">
    <!-- Lightpick CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightpick@1.6.2/css/lightpick.css">
    <style>
        body {
            font-family: 'VT323', monospace;
            background: #1a1a2e;
            color: #e0e0e0;
            margin: 0;
            padding: 1rem;
        }

        #title {
            font-size: 1.4rem;
            margin-bottom: .25rem;
            font-weight: 400;
            color: #fbbf24;
            font-family: 'Press Start 2P', monospace;
        }

        #meta {
            color: #94a3b8;
            margin-bottom: 1rem;
            font-family: 'VT323', monospace;
        }

        #ascii {
            white-space: pre;
            overflow-x: auto;
            background: #16213e;
            padding: 1rem;
            border: 1px solid #0f3460;
            border-radius: 0px;
            line-height: 1.1;
            font-family: "VT323", monospace, "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji";
            font-size: 14px;
        }

        #ascii a {
            color: #2563eb;
            text-decoration: none;
        }

        #ascii a:hover {
            color: #3b82f6;
            text-decoration: underline;
        }

        #controls {
            margin-bottom: .5rem;
            display: flex;
            gap: .5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        select,
        input {
            background: #16213e;
            color: #e0e0e0;
            border: 1px solid #0f3460;
            border-radius: 0px;
            padding: .35rem .6rem;
            font-family: 'VT323', monospace;
        }

        /* Date range picker styling */
        #daterange {
            background: #16213e;
            color: #e0e0e0;
            border: 1px solid #0f3460;
            border-radius: 0px;
            padding: .35rem .6rem;
            cursor: pointer;
            min-width: 200px;
            font-family: 'VT323', monospace;
        }

        button {
            background: #2563eb;
            color: #bfdbfe;
            border: 1px solid #1d4ed8;
            border-radius: 0px;
            padding: .35rem .8rem;
            cursor: pointer;
            font-family: 'VT323', monospace;
        }

        button:hover {
            background: #1e40af;
        }

        button:disabled {
            background: #4b5563;
            cursor: not-allowed;
            color: #9ca3af;
        }

        small {
            color: #94a3b8;
            margin-top: .5rem;
            display: block;
            font-family: 'VT323', monospace;
        }

        /* Lightpick 8-bit styling */
        .lightpick {
            background: #16213e !important;
            border: 1px solid #0f3460 !important;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5) !important;
        }

        .lightpick__month {
            background: #16213e !important;
            color: #e0e0e0 !important;
        }

        .lightpick__month-title {
            color: #e0e0e0 !important;
            background: #16213e !important;
            border-bottom: 1px solid #0f3460 !important;
        }

        .lightpick__days-of-the-week>div {
            color: #94a3b8 !important;
            background: #16213e !important;
            border-bottom: 1px solid #0f3460 !important;
        }

        .lightpick__day {
            color: #e0e0e0 !important;
        }

        .lightpick__day:hover {
            background: #0f3460 !important;
            color: #fff !important;
        }

        .lightpick__day--available:hover {
            background: #0f3460 !important;
            color: #fff !important;
        }

        .lightpick__day--disabled {
            color: #4b5563 !important;
        }

        .lightpick__day--in-range {
            background: #1e40af !important;
            color: #e0e0e0 !important;
        }

        .lightpick__day--start-date,
        .lightpick__day--end-date {
            background: #2563eb !important;
            color: #fff !important;
        }

        .lightpick__day--start-date:hover,
        .lightpick__day--end-date:hover {
            background: #1e40af !important;
            color: #fff !important;
        }

        .lightpick__previous-action,
        .lightpick__next-action {
            color: #e0e0e0 !important;
        }

        .lightpick__previous-action:hover,
        .lightpick__next-action:hover {
            color: #2563eb !important;
        }

        .lightpick__tooltip {
            background: #16213e !important;
            color: #e0e0e0 !important;
            border: 1px solid #0f3460 !important;
        }

        .lightpick__tooltip:before {
            border-top-color: #0f3460 !important;
        }

        .lightpick__tooltip:after {
            border-top-color: #16213e !important;
        }

        /* Year/Month dropdown styling */
        .lightpick__select {
            background: #16213e !important;
            color: #e0e0e0 !important;
            border: none !important;
            border-radius: 0px !important;
            outline: none !important;
            box-shadow: none !important;
        }

        .lightpick__select:hover {
            background: #0f3460 !important;
            color: #fff !important;
            border: none !important;
            outline: none !important;
        }

        .lightpick__select:focus {
            background: #0f3460 !important;
            color: #fff !important;
            border: none !important;
            outline: none !important;
            box-shadow: none !important;
        }

        .lightpick__select option {
            background: #16213e !important;
            color: #e0e0e0 !important;
        }

        /* Navigation buttons (previous/next month) */
        .lightpick__previous-action,
        .lightpick__next-action {
            background: #16213e !important;
            color: #e0e0e0 !important;
            border: 1px solid #0f3460 !important;
            border-radius: 0px !important;
        }

        .lightpick__previous-action:hover,
        .lightpick__next-action:hover {
            background: #0f3460 !important;
            color: #2563eb !important;
        }

        /* Apply/Reset buttons if they exist */
        .lightpick__apply,
        .lightpick__reset {
            background: #2563eb !important;
            color: #fff !important;
            border: 1px solid #2563eb !important;
            border-radius: 0px !important;
        }

        .lightpick__apply:hover,
        .lightpick__reset:hover {
            background: #1e40af !important;
            border-color: #1e40af !important;
        }
    </style>
</head>

<body>
    <div id="title">Loading...</div>
    <div id="meta">Loading campground availability...</div>

    <div id="controls">
        <button id="back">üó∫Ô∏è</button>
        <input type="text" id="daterange" name="daterange" />
        <button id="refresh">Reload</button>
    </div>

    <div id="ascii">Fetching...</div>
    <small>üêΩ üíñ</small>

    <!-- Lightpick dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lightpick@1.6.2/lightpick.js"></script>

    <script>
        // Function to process markdown-style links [text](url) and make them clickable
        function processLinksInText ( text ) {
            // Escape HTML to prevent XSS
            const escaped = text
                .replace( /&/g, '&amp;' )
                .replace( /</g, '&lt;' )
                .replace( />/g, '&gt;' )
                .replace( /"/g, '&quot;' )
                .replace( /'/g, '&#39;' )

            // Replace markdown links [text](url) with HTML links
            return escaped.replace( /\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>' )
        }

        document.addEventListener( 'DOMContentLoaded', function () {
            const parts = window.location.pathname.replace( /^\/+/, '' ).split( '/' )
            if ( parts.length < 3 ) {
                document.getElementById( 'ascii' ).textContent = 'Bad path. Expected /campground/{provider}/{id}'
                return
            }
            const provider = parts[ 1 ]
            const campgroundID = parts[ 2 ]
            const titleEl = document.getElementById( 'title' )
            const metaEl = document.getElementById( 'meta' )
            const asciiEl = document.getElementById( 'ascii' )
            const refreshBtn = document.getElementById( 'refresh' )
            const backBtn = document.getElementById( 'back' )

            // Parse URL params or set defaults (today + 3 weeks)
            const urlParams = new URLSearchParams( window.location.search )
            const userParam = urlParams.get( 'user' ) // Get user parameter for ad-hoc requests
            const today = moment()
            const threeWeeksLater = moment().add( 21, 'days' )

            const fromDate = urlParams.get( 'from' ) ? moment( urlParams.get( 'from' ) ) : today
            const toDate = urlParams.get( 'to' ) ? moment( urlParams.get( 'to' ) ) : threeWeeksLater

            // Back button functionality
            backBtn.onclick = function () {
                let mapUrl = '/'
                if ( userParam ) {
                    mapUrl += '?user=' + encodeURIComponent( userParam )
                }
                window.location.href = mapUrl
            }

            // Initialize Lightpick
            const picker = new Lightpick( {
                field: document.getElementById( 'daterange' ),
                singleDate: false,
                startDate: fromDate.toDate(),
                endDate: toDate.toDate(),
                format: 'YYYY-MM-DD',
                separator: ' to ',
                numberOfMonths: 2,
                numberOfColumns: 2,
                onSelect: function ( start, end ) {
                    if ( start && end ) {
                        load()
                    }
                }
            } )

            function updateUrl () {
                const newUrl = new URL( window.location )
                if ( picker.getStartDate() && picker.getEndDate() ) {
                    newUrl.searchParams.set( 'from', moment( picker.getStartDate() ).format( 'YYYY-MM-DD' ) )
                    newUrl.searchParams.set( 'to', moment( picker.getEndDate() ).format( 'YYYY-MM-DD' ) )
                    history.replaceState( null, '', newUrl )
                }
            }

            let loading = false
            async function load () {
                if ( loading ) return // prevent overlap
                loading = true
                refreshBtn.disabled = true
                asciiEl.textContent = 'Loading...'
                try {
                    const from = picker.getStartDate() ? moment( picker.getStartDate() ).format( 'YYYY-MM-DD' ) : fromDate.format( 'YYYY-MM-DD' )
                    const to = picker.getEndDate() ? moment( picker.getEndDate() ).format( 'YYYY-MM-DD' ) : toDate.format( 'YYYY-MM-DD' )
                    const resp = await fetch( `/api/campground_state/${ provider }/${ campgroundID }?from=${ from }&to=${ to }` )
                    const txt = await resp.text()
                    const name = resp.headers.get( 'X-Campground-Name' ) || campgroundID
                    const isRefreshing = resp.headers.get( 'X-Refresh-In-Progress' ) === 'true'

                    titleEl.textContent = `${ name } [${ provider }/${ campgroundID }]`
                    if ( isRefreshing ) {
                        metaEl.textContent = `Refreshing data from ${ from } to ${ to }... will update shortly`
                    } else {
                        metaEl.textContent = `O = available . = unavailable (click campsite names to view details)`
                    }

                    // Parse markdown-style links in the ASCII text and make them clickable
                    const processedText = processLinksInText( txt )
                    asciiEl.innerHTML = processedText
                    updateUrl()

                    // If refresh is in progress, schedule another load in 1 second
                    if ( isRefreshing ) {
                        setTimeout( () => {
                            if ( !loading ) { // Only retry if not already loading
                                load()
                            }
                        }, 1000 )
                    }
                } catch ( e ) {
                    asciiEl.textContent = 'Error: ' + e
                } finally {
                    refreshBtn.disabled = false
                    loading = false
                }
            }

            refreshBtn.onclick = load
            load()
        } );
    </script>
</body>

</html>