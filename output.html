<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schniffer - Campground Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    <style>ZgotmplZ</style>
</head>
<body>
    <div id="header">
        <h1>üèïÔ∏è Schniffer Campground Map</h1>
        <p>Explore campgrounds from Recreation.gov and ReserveCalifornia</p>
    </div>
    
    <div id="controls">
        <input type="text" id="search" placeholder="Search campgrounds..." />
        
        <div class="provider-filter">
            <input type="checkbox" id="recreation_gov" checked>
            <label for="recreation_gov">Recreation.gov</label>
        </div>
        
        <div class="provider-filter">
            <input type="checkbox" id="reservecalifornia" checked>
            <label for="reservecalifornia">ReserveCalifornia</label>
        </div>
        
        <div class="stats" id="stats">
            Loading campgrounds...
        </div>
    </div>
    
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    <script>"// Initialize the map\nconst map = L.map('map').setView([39.8283, -98.5795], 4); // Center of US\n\n// Add OpenStreetMap tiles\nL.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\n    attribution: '\u0026copy; \u003ca href=\"https://www.openstreetmap.org/copyright\"\u003eOpenStreetMap\u003c/a\u003e contributors'\n}).addTo(map);\n\nlet markers = [];\nlet currentData = null;\n\n// Custom icons for different providers\nconst recreationIcon = L.divIcon({\n    className: 'custom-div-icon',\n    html: '\u003cdiv style=\"background-color: #27ae60; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);\"\u003eR\u003c/div\u003e',\n    iconSize: [20, 20],\n    iconAnchor: [10, 10]\n});\n\nconst californiaIcon = L.divIcon({\n    className: 'custom-div-icon',\n    html: '\u003cdiv style=\"background-color: #e74c3c; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);\"\u003eC\u003c/div\u003e',\n    iconSize: [20, 20],\n    iconAnchor: [10, 10]\n});\n\n// Create cluster icon with count\nfunction createClusterIcon(count) {\n    const size = Math.min(Math.max(20 + Math.log10(count) * 10, 25), 50);\n    return L.divIcon({\n        className: 'custom-div-icon',\n        html: `\u003cdiv style=\"background-color: #3498db; color: white; border-radius: 50%; width: ${size}px; height: ${size}px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.4); font-size: ${Math.min(size/3, 14)}px;\"\u003e${count}\u003c/div\u003e`,\n        iconSize: [size, size],\n        iconAnchor: [size/2, size/2]\n    });\n}\n\n// Load campgrounds for current viewport\nasync function loadViewportData() {\n    const bounds = map.getBounds();\n    const zoom = map.getZoom();\n    \n    const viewport = {\n        north: bounds.getNorth(),\n        south: bounds.getSouth(),\n        east: bounds.getEast(),\n        west: bounds.getWest(),\n        zoom: zoom\n    };\n    \n    try {\n        const response = await fetch('/api/viewport', {\n            method: 'POST',\n            headers: {\n                'Content-Type': 'application/json',\n            },\n            body: JSON.stringify(viewport)\n        });\n        \n        const result = await response.json();\n        currentData = result;\n        renderMarkersFromViewport(result);\n        updateStatsFromViewport(result);\n    } catch (error) {\n        console.error('Failed to load viewport data:', error);\n        document.getElementById('stats').textContent = 'Failed to load campgrounds';\n    }\n}\n\nfunction updateStatsFromViewport(result) {\n    if (result.type === 'clusters') {\n        const totalCount = result.data.reduce((sum, cluster) =\u003e sum + cluster.count, 0);\n        document.getElementById('stats').textContent = \n            `${totalCount} campgrounds in ${result.data.length} clusters (zoom in for details)`;\n    } else {\n        const recCount = result.data.filter(c =\u003e c.provider === 'recreation_gov').length;\n        const calCount = result.data.filter(c =\u003e c.provider === 'reservecalifornia').length;\n        document.getElementById('stats').textContent = \n            `${result.data.length} campgrounds visible (${recCount} Recreation.gov, ${calCount} ReserveCalifornia)`;\n    }\n}\n\nfunction renderMarkersFromViewport(result) {\n    // Clear existing markers\n    markers.forEach(marker =\u003e map.removeLayer(marker));\n    markers = [];\n    \n    // Get filter states\n    const showRecreation = document.getElementById('recreation_gov').checked;\n    const showCalifornia = document.getElementById('reservecalifornia').checked;\n    const searchTerm = document.getElementById('search').value.toLowerCase();\n    \n    if (result.type === 'clusters') {\n        // Render clusters\n        result.data.forEach(cluster =\u003e {\n            const marker = L.marker([cluster.lat, cluster.lon], { \n                icon: createClusterIcon(cluster.count) \n            }).bindPopup(`\n                \u003cdiv class=\"custom-popup\"\u003e\n                    \u003cdiv class=\"popup-title\"\u003e${cluster.count} Campgrounds\u003c/div\u003e\n                    \u003cdiv style=\"margin-top: 0.5rem;\"\u003e\n                        ${cluster.names.slice(0, 3).map(name =\u003e `\u003cdiv style=\"font-size: 0.9rem; margin: 0.2rem 0;\"\u003e‚Ä¢ ${name}\u003c/div\u003e`).join('')}\n                        ${cluster.names.length \u003e 3 ? `\u003cdiv style=\"font-size: 0.8rem; color: #666; margin-top: 0.3rem;\"\u003e... and ${cluster.count - 3} more\u003c/div\u003e` : ''}\n                        \u003cdiv style=\"font-size: 0.8rem; color: #666; margin-top: 0.5rem;\"\u003eZoom in to see individual campgrounds\u003c/div\u003e\n                    \u003c/div\u003e\n                \u003c/div\u003e\n            `).addTo(map);\n            \n            markers.push(marker);\n        });\n    } else {\n        // Render individual campgrounds\n        const filteredCampgrounds = result.data.filter(campground =\u003e {\n            const matchesProvider = \n                (campground.provider === 'recreation_gov' \u0026\u0026 showRecreation) ||\n                (campground.provider === 'reservecalifornia' \u0026\u0026 showCalifornia);\n            \n            const matchesSearch = !searchTerm || \n                campground.name.toLowerCase().includes(searchTerm);\n            \n            return matchesProvider \u0026\u0026 matchesSearch;\n        });\n        \n        filteredCampgrounds.forEach(campground =\u003e {\n            const icon = campground.provider === 'recreation_gov' ? recreationIcon : californiaIcon;\n            \n            const marker = L.marker([campground.lat, campground.lon], { icon })\n                .bindPopup(`\n                    \u003cdiv class=\"custom-popup\"\u003e\n                        \u003cdiv class=\"popup-title\"\u003e${campground.name}\u003c/div\u003e\n                        \u003cdiv class=\"popup-provider ${campground.provider}\"\u003e${campground.provider.replace('_', ' ')}\u003c/div\u003e\n                        \u003cdiv class=\"popup-coordinates\"\u003e\n                            ${campground.lat.toFixed(4)}, ${campground.lon.toFixed(4)}\n                        \u003c/div\u003e\n                    \u003c/div\u003e\n                `)\n                .addTo(map);\n            \n            markers.push(marker);\n        });\n    }\n}\n\n// Event listeners\nmap.on('moveend zoomend', loadViewportData);\n\ndocument.getElementById('recreation_gov').addEventListener('change', () =\u003e {\n    if (currentData) renderMarkersFromViewport(currentData);\n});\ndocument.getElementById('reservecalifornia').addEventListener('change', () =\u003e {\n    if (currentData) renderMarkersFromViewport(currentData);\n});\n\nlet searchTimeout;\ndocument.getElementById('search').addEventListener('input', () =\u003e {\n    clearTimeout(searchTimeout);\n    searchTimeout = setTimeout(() =\u003e {\n        if (currentData) renderMarkersFromViewport(currentData);\n    }, 300);\n});\n\n// Load initial data\nloadViewportData();\n"</script>
</body>
</html>
